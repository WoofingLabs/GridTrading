<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GateLayer Grid Trading</title>
    <link rel="icon" type="image/jpeg" href="images/gcat_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0068FF',
                        secondary: '#18E5A0',
                        accent: '#FFD700',
                        dark: '#070808',
                        'light-gray': '#E5E7EB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Changa One', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow-glow {
                text-shadow: 0 0 10px rgba(0, 104, 255, 0.5);
            }
            .glow-border {
                box-shadow: 0 0 12px rgba(24, 229, 160, 0.3);
            }
            .bg-grid {
                background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="1" cy="1" r="1" fill="%230068FF" fill-opacity="0.1"/%3E%3C/svg%3E');
                background-size: 20px 20px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Changa+One&display=swap" rel="stylesheet">
</head>
<body class="bg-dark text-white font-sans overflow-x-hidden">
    <header class="fixed w-full z-50 bg-dark/90 backdrop-blur-md transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer hover:text-primary transition-colors">
                <div class="w-10 h-10 rounded-full overflow-hidden">
                    <img src="images/gcat_logo.png" alt="Logo" class="w-full h-full object-cover">
                </div>
                <span class="font-display text-3xl text-primary text-shadow-glow">GateLayer Grid Trading</span>
            </div>
            <button id="menuToggle" class="md:hidden text-2xl text-primary">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <div id="mobileMenu" class="md:hidden bg-dark/95 absolute w-full top-full py-4 px-4 hidden">
            <div class="flex flex-col space-y-4">
                <a href="#grid" class="hover:text-primary transition-colors py-2 text-white">Grid Trading</a>
            </div>
        </div>
    </header>

    <section id="grid" class="min-h-screen pt-24 pb-16 bg-grid relative overflow-hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-gradient-to-b from-primary/10 to-dark pointer-events-none"></div>
        <div class="absolute top-0 left-0 w-80 h-80 bg-primary/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-80 h-80 bg-secondary/10 rounded-full blur-3xl"></div>
        <div class="container mx-auto px-4 text-center relative z-10">
            <div class="w-48 h-48 mx-auto mb-8 animate-float">
                <img src="images/gcat_logo.png" alt="Logo" class="w-full h-full object-cover rounded-full border-4 border-secondary/50 glow-border">
            </div>
            <h1 class="font-display text-5xl md:text-7xl mb-6 text-primary text-shadow-glow">Grid Trading on GateSwap</h1>
            <p class="text-xl md:text-2xl text-light-gray max-w-3xl mx-auto mb-10">
                Automate trading with a grid strategy for your favorite tokens on GateLayer.
            </p>
            <div class="bg-dark/50 p-6 rounded-lg border border-primary/30 max-w-md mx-auto mb-8">
                <div class="flex flex-col space-y-4">
                    <div>
                        <label class="block text-left text-light-gray mb-2">RPC URL</label>
                        <input id="rpcUrl" type="text" value="https://gatelayer-mainnet.gatenode.cc" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">Chain ID</label>
                        <input id="chainId" type="text" value="10088" readonly class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">Gas Price (Gwei)</label>
                        <input id="gasPrice" type="number" value="0.5" step="0.1" min="0" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">Slippage Tolerance (%)</label>
                        <input id="slippage" type="number" value="5" step="0.1" min="0" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">基准价格 (GT)</label>
                        <input id="basePrice" type="number" value="0.001" step="0.0001" min="0" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">价格区间 (%)</label>
                        <input id="priceRange" type="number" value="10" step="1" min="0" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-left text-light-gray mb-2">网格数量</label>
                        <input id="gridCount" type="number" value="10" step="1" min="2" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">每网格金额 (GT)</label>
                        <input id="gridAmount" type="number" value="0.01" step="0.001" min="0" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">Private Key (start with 0x)</label>
                        <input id="privateKey" type="text" placeholder="0x..." class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                    </div>
                    <div>
                        <label class="block text-left text-light-gray mb-2">Token</label>
                        <select id="tokenSelect" class="w-full px-4 py-2 bg-dark/80 border border-primary/20 rounded-lg text-white focus:outline-none focus:border-secondary">
                            <option value="0xf6d9cf57e20ba0d33372e8998a9424aa53411e04">GDOG</option>
                            <option value="0x614025d5b75a1e762111d4b845633728774d888a">MIMA</option>
                            <option value="0xd30d04405bbeb573ce4d8697fb4b3bcda6eb1777">GCAT (Blue)</option>
                            <option value="0xfb7a49bd483de0f2ed479f82a3f7f7f53e9e4057">GM</option>
                            <option value="0x01ec580a60dbf3c8f3e00805c5489037eff35675">GCAT (Black)</option>
                            <option value="0x8e0474a49163f1764d56a9fd9342b87f1d1aec00">LUCKY</option>
                            <option value="0x8b78ddf4c0908f3ddb23f27d8bd06b9daab8c7e2">TEST</option>
                        </select>
                    </div>
                    <div class="flex justify-center gap-4">
                        <button id="startButton" class="px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-primary/80 transition-all">启动机器人</button>
                        <button id="stopButton" class="px-6 py-3 bg-dark/80 border border-secondary text-secondary rounded-full font-medium hover:bg-secondary/10 transition-all">停止机器人</button>
                        <button id="checkBalanceButton" class="px-6 py-3 bg-secondary text-dark rounded-full font-medium hover:bg-secondary/80 transition-all">检查余额</button>
                        <button id="approveButton" class="px-6 py-3 bg-secondary text-dark rounded-full font-medium hover:bg-secondary/80 transition-all hidden">Approve Token</button>
                    </div>
                    <p id="status" class="text-light-gray text-sm">状态: 就绪</p>
                    <p id="balanceStatus" class="text-light-gray text-sm">GT 余额: 0 | 代币余额: 0</p>
                    <p id="gridStatus" class="text-light-gray text-sm">网格状态: 未设置</p>
                    <div id="log" class="h-24 overflow-y-auto bg-dark/80 p-3 rounded-lg border border-primary/20 text-sm text-light-gray"></div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-dark/95 py-12 border-t border-primary/20">
        <div class="container mx-auto px-4 text-center">
            <p class="text-light-gray text-sm">© 2025 GateLayer Grid Trading. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
        const GATE_ROUTER_ADDRESS = "0x12814690f59a9ce8ba87dc8cf0692442baa9c097";
        const WGT_ADDRESS = "0x6803b8e93b13941f6b73b82e324b80251b3de338";
        const TOKEN_ADDRESSES = {
            "GDOG": "0xf6d9cf57e20ba0d33372e8998a9424aa53411e04",
            "MIMA": "0x614025d5b75a1e762111d4b845633728774d888a",
            "GCAT (Blue)": "0xd30d04405bbeb573ce4d8697fb4b3bcda6eb1777",
            "GM": "0xfb7a49bd483de0f2ed479f82a3f7f7f53e9e4057",
            "GCAT (Black)": "0x01ec580a60dbf3c8f3e00805c5489037eff35675",
            "LUCKY": "0x8e0474a49163f1764d56a9fd9342b87f1d1aec00",
            "TEST": "0x8b78ddf4c0908f3ddb23f27d8bd06b9daab8c7e2"
        };

        const GATE_ROUTER_ABI = [
            {
                "inputs": [
                    { "internalType": "uint256", "name": "amountOutMin", "type": "uint256" },
                    { "internalType": "address[]", "name": "path", "type": "address[]" },
                    { "internalType": "address", "name": "to", "type": "address" },
                    { "internalType": "uint256", "name": "deadline", "type": "uint256" }
                ],
                "name": "swapExactETHForTokensSupportingFeeOnTransferTokens",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "amountIn", "type": "uint256" },
                    { "internalType": "address[]", "name": "path", "type": "address[]" }
                ],
                "name": "getAmountsOut",
                "outputs": [{ "internalType": "uint256[]", "name": "amounts", "type": "uint256[]" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "amountIn", "type": "uint256" },
                    { "internalType": "uint256", "name": "amountOutMin", "type": "uint256" },
                    { "internalType": "address[]", "name": "path", "type": "address[]" },
                    { "internalType": "address", "name": "to", "type": "address" },
                    { "internalType": "uint256", "name": "deadline", "type": "uint256" }
                ],
                "name": "swapExactTokensForETHSupportingFeeOnTransferTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        const ERC20_ABI = [
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{ "name": "", "type": "uint8" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{ "name": "_owner", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "name": "balance", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    { "name": "_spender", "type": "address" },
                    { "name": "_value", "type": "uint256" }
                ],
                "name": "approve",
                "outputs": [{ "name": "success", "type": "bool" }],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    { "name": "_owner", "type": "address" },
                    { "name": "_spender", "type": "address" }
                ],
                "name": "allowance",
                "outputs": [{ "name": "remaining", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const messages = {
            statusReady: "状态: 就绪",
            testingRPC: "正在测试 RPC 连接...",
            connectedToChain: "已连接到链 ID: ",
            expectedChain: " (Gate Layer 应为 10088)",
            chainMismatch: "错误: 未连接到 Gate Layer (链 ID 应为 10088)",
            rpcError: "错误: 无法连接到 RPC: ",
            noPrivateKey: "错误: 未提供私钥",
            invalidPrivateKey: "错误: 无效的私钥",
            invalidGasPrice: "错误: 无效的 Gas Price",
            invalidGridParams: "错误: 无效的网格参数（基准价格、价格区间、网格数量需有效）",
            insufficientBalance: "错误: 余额不足",
            insufficientAllowance: "错误: 代币未授权，请先授权",
            approvingToken: "正在授权代币 ",
            approveSuccess: "代币授权成功",
            approveFail: "代币授权失败: ",
            buyingToken: "正在购买代币 ",
            sellingToken: "正在卖出代币 ",
            tradeSuccess: "交易成功！交易哈希: ",
            errorProcessing: "处理钱包时出错 ",
            errorMessage: ": ",
            buttonProcessing: "处理中..."
        };

        function getMessage(key) {
            return messages[key] || key;
        }

        let web3Instance = null;
        let botRunning = false;
        let autoBuyInterval = null;
        let wallet = null;
        let selectedToken = "0xf6d9cf57e20ba0d33372e8998a9424aa53411e04";
        let tokenSymbol = "GDOG";
        let tokenDecimals = 1; // 默认 GDOG 为 1 位小数

        function log(message) {
            const logDiv = document.getElementById("log");
            if (!logDiv._pendingLog) {
                logDiv._pendingLog = [];
                setTimeout(() => {
                    logDiv.innerHTML += logDiv._pendingLog.map(msg => `<p>${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}: ${msg}</p>`).join('');
                    logDiv.scrollTop = logDiv.scrollHeight;
                    logDiv._pendingLog = null;
                }, 50);
            }
            logDiv._pendingLog.push(message);
        }

        async function initializeWeb3() {
            const rpcUrl = document.getElementById("rpcUrl").value.trim();
            const status = document.getElementById("status");
            try {
                const provider = new Web3.providers.HttpProvider(rpcUrl, { timeout: 10000 });
                const web3 = new Web3(provider);
                status.textContent = getMessage("testingRPC") + "\n";
                log(getMessage("testingRPC"));
                const networkChainId = await web3.eth.getChainId();
                status.textContent += getMessage("connectedToChain") + networkChainId + getMessage("expectedChain") + "\n";
                log(getMessage("connectedToChain") + networkChainId + getMessage("expectedChain"));
                if (networkChainId !== 10088) {
                    status.textContent += getMessage("chainMismatch") + "\n";
                    status.textContent += "请尝试其他 RPC URL，如 https://gatelayer-rpc.gatenode.cc 或 https://rpc.gatelayer.org\n";
                    log(getMessage("chainMismatch"));
                    return null;
                }
                return web3;
            } catch (error) {
                status.textContent += getMessage("rpcError") + error.message + "\n";
                status.textContent += "请尝试其他 RPC URL，如 https://gatelayer-rpc.gatenode.cc 或 https://rpc.gatelayer.org\n";
                log(getMessage("rpcError") + error.message);
                return null;
            }
        }

        async function waitForTransaction(txHash) {
            let receipt = null;
            const maxAttempts = 30;
            let attempts = 0;
            while (attempts < maxAttempts) {
                receipt = await web3Instance.eth.getTransactionReceipt(txHash);
                if (receipt) {
                    if (receipt.status) return receipt;
                    throw new Error(`交易 ${txHash} 失败`);
                }
                await new Promise(resolve => setTimeout(resolve, 2000));
                attempts++;
            }
            throw new Error(`交易 ${txHash} 未在 ${maxAttempts} 次尝试后确认`);
        }

        async function checkTokenDecimals() {
            const tokenContract = new web3Instance.eth.Contract(ERC20_ABI, selectedToken);
            try {
                tokenDecimals = await tokenContract.methods.decimals().call();
                log(`代币 ${tokenSymbol} 小数位: ${tokenDecimals}`);
            } catch (error) {
                log(`获取代币小数位失败，假设为 1: ${error.message}`);
                tokenDecimals = selectedToken.toLowerCase() === TOKEN_ADDRESSES["GDOG"].toLowerCase() ? 1 : 18;
            }
        }

        async function checkAndApproveToken(wallet) {
            const tokenContract = new web3Instance.eth.Contract(ERC20_ABI, selectedToken);
            const gasPrice = web3Instance.utils.toWei(document.getElementById("gasPrice").value, "gwei");
            try {
                const allowance = await tokenContract.methods.allowance(wallet.address, GATE_ROUTER_ADDRESS).call();
                if (web3Instance.utils.toBN(allowance).gte(web3Instance.utils.toBN(2).pow(web3Instance.utils.toBN(256)).div(web3Instance.utils.toBN(2)))) {
                    log(getMessage("approveSuccess") + wallet.address);
                    document.getElementById("approveButton").classList.add("hidden");
                    return true;
                }
                document.getElementById("approveButton").classList.remove("hidden");
                document.getElementById("startButton").disabled = true;
                log(getMessage("insufficientAllowance"));
                return false;
            } catch (error) {
                log(getMessage("approveFail") + error.message);
                document.getElementById("approveButton").classList.remove("hidden");
                document.getElementById("startButton").disabled = true;
                return false;
            }
        }

        async function approveToken() {
            const approveButton = document.getElementById("approveButton");
            approveButton.disabled = true;
            approveButton.innerHTML = getMessage("buttonProcessing") + ' <i class="fa fa-spinner fa-spin ml-2"></i>';
            const status = document.getElementById("status");
            try {
                web3Instance.eth.accounts.wallet.add(wallet.privateKey);
                const tokenContract = new web3Instance.eth.Contract(ERC20_ABI, selectedToken);
                const gasPrice = web3Instance.utils.toWei(document.getElementById("gasPrice").value, "gwei");
                log(getMessage("approvingToken") + wallet.address + "...");
                status.textContent += getMessage("approvingToken") + wallet.address + "\n";
                const estimatedGas = await tokenContract.methods.approve(GATE_ROUTER_ADDRESS, web3Instance.utils.toBN(2).pow(web3Instance.utils.toBN(256)).sub(web3Instance.utils.toBN(1))).estimateGas({ from: wallet.address });
                const tx = await tokenContract.methods.approve(GATE_ROUTER_ADDRESS, web3Instance.utils.toBN(2).pow(web3Instance.utils.toBN(256)).sub(web3Instance.utils.toBN(1))).send({
                    from: wallet.address,
                    gas: Math.min(estimatedGas * 2, 1000000),
                    gasPrice
                });
                await waitForTransaction(tx.transactionHash);
                log(getMessage("approveSuccess") + ": " + tx.transactionHash);
                status.textContent += getMessage("approveSuccess") + "\n";
                document.getElementById("approveButton").classList.add("hidden");
                document.getElementById("startButton").disabled = false;
                return true;
            } catch (error) {
                log(getMessage("approveFail") + error.message);
                status.textContent += getMessage("approveFail") + error.message + "\n";
                return false;
            } finally {
                approveButton.disabled = false;
                approveButton.innerHTML = "Approve Token";
            }
        }

        async function checkBalances() {
            const checkButton = document.getElementById("checkBalanceButton");
            checkButton.disabled = true;
            checkButton.innerHTML = getMessage("buttonProcessing") + ' <i class="fa fa-spinner fa-spin ml-2"></i>';
            const status = document.getElementById("status");
            status.textContent = getMessage("statusReady") + "\n";
            if (!web3Instance) {
                web3Instance = await initializeWeb3();
                if (!web3Instance) {
                    checkButton.disabled = false;
                    checkButton.innerHTML = "检查余额";
                    return;
                }
            }
            const privateKey = document.getElementById("privateKey").value.trim();
            if (!privateKey) {
                status.textContent += getMessage("noPrivateKey") + "\n";
                log(getMessage("noPrivateKey"));
                checkButton.disabled = false;
                checkButton.innerHTML = "检查余额";
                return;
            }
            try {
                wallet = web3Instance.eth.accounts.privateKeyToAccount(privateKey);
                const tokenContract = new web3Instance.eth.Contract(ERC20_ABI, selectedToken);
                await checkTokenDecimals();
                const gtBalance = await web3Instance.eth.getBalance(wallet.address);
                const tokenBalance = await tokenContract.methods.balanceOf(wallet.address).call();
                const gtBalanceFormatted = Number(web3Instance.utils.fromWei(gtBalance, "ether")).toFixed(4);
                const tokenBalanceFormatted = Number(web3Instance.utils.fromWei(tokenBalance, tokenDecimals === 1 ? "ether" : "ether")).toFixed(tokenDecimals === 1 ? 1 : 4);
                status.textContent += getMessage("processingWallet") + wallet.address + "\n";
                status.textContent += getMessage("gtBalance") + gtBalanceFormatted + " GT\n";
                status.textContent += getMessage("tokenBalance") + tokenBalanceFormatted + ` ${tokenSymbol}\n`;
                document.getElementById("balanceStatus").textContent = `GT 余额: ${gtBalanceFormatted} | 代币余额: ${tokenBalanceFormatted} ${tokenSymbol}`;
                log(`${getMessage("processingWallet")}${wallet.address}: ${getMessage("gtBalance")}${gtBalanceFormatted} GT, ${getMessage("tokenBalance")}${tokenBalanceFormatted} ${tokenSymbol}`);
                await checkAndApproveToken(wallet);
            } catch (error) {
                status.textContent += getMessage("invalidPrivateKey") + getMessage("errorMessage") + error.message + "\n";
                log(getMessage("invalidPrivateKey") + getMessage("errorMessage") + error.message);
            }
            checkButton.disabled = false;
            checkButton.innerHTML = "检查余额";
        }

        function calculateGrid() {
            const basePrice = parseFloat(document.getElementById("basePrice").value);
            const priceRange = parseFloat(document.getElementById("priceRange").value) / 100;
            const gridCount = parseInt(document.getElementById("gridCount").value);
            if (isNaN(basePrice) || basePrice <= 0 || isNaN(priceRange) || priceRange < 0 || isNaN(gridCount) || gridCount < 2) {
                log(getMessage("invalidGridParams"));
                document.getElementById("gridStatus").textContent = getMessage("invalidGridParams");
                return null;
            }
            const minPrice = basePrice * (1 - priceRange);
            const maxPrice = basePrice * (1 + priceRange);
            const interval = (maxPrice - minPrice) / (gridCount - 1);
            const grids = [];
            for (let i = 0; i < gridCount; i++) {
                const price = minPrice + interval * i;
                grids.push({
                    price: price.toFixed(6),
                    type: price < basePrice ? "buy" : price > basePrice ? "sell" : "neutral"
                });
            }
            document.getElementById("gridStatus").textContent = `网格状态: ${grids.map(g => `${g.type === "buy" ? "买" : g.type === "sell" ? "卖" : "中立"}@${g.price} GT`).join(", ")}`;
            return grids;
        }

        async function purchaseGateSwap(wallet, GTAmount) {
            try {
                web3Instance.eth.accounts.wallet.add(wallet.privateKey);
                const routerContract = new web3Instance.eth.Contract(GATE_ROUTER_ABI, GATE_ROUTER_ADDRESS);
                const gasPrice = web3Instance.utils.toWei(document.getElementById("gasPrice").value, "gwei");
                const GTAmountWei = web3Instance.utils.toWei(GTAmount.toString(), "ether");
                const path = [WGT_ADDRESS, selectedToken];
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                const balance = await web3Instance.eth.getBalance(wallet.address);
                const balanceGT = web3Instance.utils.fromWei(balance, "ether");
                if (parseFloat(balanceGT) < parseFloat(GTAmount) + 0.01) {
                    log(getMessage("insufficientBalance") + `: ${balanceGT} GT`);
                    document.getElementById("status").textContent += getMessage("insufficientBalance") + `: ${balanceGT} GT\n`;
                    return false;
                }
                let attempts = 0;
                const maxAttempts = 3;
                let nonce = await web3Instance.eth.getTransactionCount(wallet.address, "pending");
                while (attempts < maxAttempts) {
                    try {
                        const amounts = await routerContract.methods.getAmountsOut(GTAmountWei, path).call();
                        const tokenAmount = web3Instance.utils.fromWei(amounts[1], tokenDecimals === 1 ? "ether" : "ether");
                        const tokenAmountWei = web3Instance.utils.toWei(tokenAmount, tokenDecimals === 1 ? "ether" : "ether");
                        const slippagePercent = parseFloat(document.getElementById("slippage").value) / 100;
                        const tokenAmountMin = web3Instance.utils.toBN(tokenAmountWei).mul(web3Instance.utils.toBN(Math.floor((1 - slippagePercent) * 1000))).div(web3Instance.utils.toBN(1000));
                        const estimatedGas = await routerContract.methods.swapExactETHForTokensSupportingFeeOnTransferTokens(tokenAmountMin, path, wallet.address, deadline).estimateGas({
                            from: wallet.address,
                            value: GTAmountWei
                        });
                        const tx = await routerContract.methods.swapExactETHForTokensSupportingFeeOnTransferTokens(tokenAmountMin, path, wallet.address, deadline).send({
                            from: wallet.address,
                            value: GTAmountWei,
                            gas: Math.min(estimatedGas * 2, 3000000),
                            gasPrice,
                            nonce
                        });
                        await waitForTransaction(tx.transactionHash);
                        const txLink = `https://www.gatescan.org/gatelayer/tx/${tx.transactionHash}`;
                        log(getMessage("tradeSuccess") + tx.transactionHash);
                        document.getElementById("status").textContent += `GateSwap 购买: ${GTAmount} GT -> ~${parseFloat(tokenAmount).toFixed(tokenDecimals === 1 ? 1 : 4)} ${tokenSymbol}, TX: ${txLink}\n`;
                        return true;
                    } catch (error) {
                        attempts++;
                        log(`GateSwap 购买失败 (尝试 ${attempts}/${maxAttempts}): ${error.message}`);
                        if (error.message.includes("replacement transaction underpriced") || error.message.includes("nonce too low")) {
                            nonce = await web3Instance.eth.getTransactionCount(wallet.address, "pending");
                        }
                        if (attempts === maxAttempts) {
                            log(`GateSwap 购买失败: ${wallet.address}: ${error.message}`);
                            document.getElementById("status").textContent += `GateSwap 购买失败: ${error.message}\n`;
                            return false;
                        }
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            } catch (error) {
                log(`GateSwap 错误: ${error.message}`);
                document.getElementById("status").textContent += `GateSwap 错误: ${error.message}\n`;
                return false;
            }
        }

        async function sellGateSwap(wallet, tokenAmount) {
            try {
                web3Instance.eth.accounts.wallet.add(wallet.privateKey);
                const approved = await checkAndApproveToken(wallet);
                if (!approved) {
                    log(getMessage("insufficientAllowance"));
                    document.getElementById("status").textContent += getMessage("insufficientAllowance") + "\n";
                    return false;
                }
                const routerContract = new web3Instance.eth.Contract(GATE_ROUTER_ABI, GATE_ROUTER_ADDRESS);
                const gasPrice = web3Instance.utils.toWei(document.getElementById("gasPrice").value, "gwei");
                const tokenAmountWei = web3Instance.utils.toWei(tokenAmount.toString(), tokenDecimals === 1 ? "ether" : "ether");
                const path = [selectedToken, WGT_ADDRESS];
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                const tokenContract = new web3Instance.eth.Contract(ERC20_ABI, selectedToken);
                const tokenBalance = await tokenContract.methods.balanceOf(wallet.address).call();
                const tokenBalanceFormatted = web3Instance.utils.fromWei(tokenBalance, tokenDecimals === 1 ? "ether" : "ether");
                if (parseFloat(tokenBalanceFormatted) < parseFloat(tokenAmount)) {
                    log(getMessage("insufficientBalance") + `: ${tokenBalanceFormatted} ${tokenSymbol}`);
                    document.getElementById("status").textContent += getMessage("insufficientBalance") + `: ${tokenBalanceFormatted} ${tokenSymbol}\n`;
                    return false;
                }
                let attempts = 0;
                const maxAttempts = 3;
                let nonce = await web3Instance.eth.getTransactionCount(wallet.address, "pending");
                while (attempts < maxAttempts) {
                    try {
                        const amounts = await routerContract.methods.getAmountsOut(tokenAmountWei, path).call();
                        const GTAmountMin = web3Instance.utils.toBN(amounts[1]).mul(web3Instance.utils.toBN(Math.floor((1 - parseFloat(document.getElementById("slippage").value) / 100) * 1000))).div(web3Instance.utils.toBN(1000));
                        const estimatedGas = await routerContract.methods.swapExactTokensForETHSupportingFeeOnTransferTokens(tokenAmountWei, GTAmountMin, path, wallet.address, deadline).estimateGas({
                            from: wallet.address
                        });
                        const tx = await routerContract.methods.swapExactTokensForETHSupportingFeeOnTransferTokens(tokenAmountWei, GTAmountMin, path, wallet.address, deadline).send({
                            from: wallet.address,
                            gas: Math.min(estimatedGas * 2, 3000000),
                            gasPrice,
                            nonce
                        });
                        await waitForTransaction(tx.transactionHash);
                        const txLink = `https://www.gatescan.org/gatelayer/tx/${tx.transactionHash}`;
                        log(getMessage("tradeSuccess") + tx.transactionHash);
                        document.getElementById("status").textContent += `GateSwap 卖出: ${tokenAmount} ${tokenSymbol} -> GT, TX: ${txLink}\n`;
                        return true;
                    } catch (error) {
                        attempts++;
                        log(`GateSwap 卖出失败 (尝试 ${attempts}/${maxAttempts}): ${error.message}`);
                        if (error.message.includes("replacement transaction underpriced") || error.message.includes("nonce too low")) {
                            nonce = await web3Instance.eth.getTransactionCount(wallet.address, "pending");
                        }
                        if (attempts === maxAttempts) {
                            log(`GateSwap 卖出失败: ${wallet.address}: ${error.message}`);
                            document.getElementById("status").textContent += `GateSwap 卖出失败: ${error.message}\n`;
                            return false;
                        }
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            } catch (error) {
                log(`GateSwap 卖出错误: ${error.message}`);
                document.getElementById("status").textContent += `GateSwap 卖出错误: ${error.message}\n`;
                return false;
            }
        }

        async function startBot() {
            const startButton = document.getElementById("startButton");
            startButton.disabled = true;
            startButton.innerHTML = getMessage("buttonProcessing") + ' <i class="fa fa-spinner fa-spin ml-2"></i>';
            const status = document.getElementById("status");
            status.textContent = getMessage("statusReady") + "\n";
            if (botRunning) {
                log("错误: 机器人已在运行");
                status.textContent += "错误: 机器人已在运行\n";
                startButton.disabled = false;
                startButton.innerHTML = "启动机器人";
                return;
            }
            const privateKey = document.getElementById("privateKey").value.trim();
            const gasPrice = parseFloat(document.getElementById("gasPrice").value);
            const grids = calculateGrid();
            if (!privateKey) {
                log(getMessage("noPrivateKey"));
                status.textContent += getMessage("noPrivateKey") + "\n";
                startButton.disabled = false;
                startButton.innerHTML = "启动机器人";
                return;
            }
            if (isNaN(gasPrice) || gasPrice <= 0) {
                log(getMessage("invalidGasPrice"));
                status.textContent += getMessage("invalidGasPrice") + "\n";
                startButton.disabled = false;
                startButton.innerHTML = "启动机器人";
                return;
            }
            if (!grids) {
                status.textContent += getMessage("invalidGridParams") + "\n";
                startButton.disabled = false;
                startButton.innerHTML = "启动机器人";
                return;
            }
            try {
                wallet = web3Instance ? web3Instance.eth.accounts.privateKeyToAccount(privateKey) : null;
                log(`有效私钥: 地址 ${wallet.address}`);
                status.textContent += `有效私钥: 地址 ${wallet.address}\n`;
            } catch (error) {
                log(getMessage("invalidPrivateKey") + getMessage("errorMessage") + error.message);
                status.textContent += getMessage("invalidPrivateKey") + getMessage("errorMessage") + error.message + "\n";
                startButton.disabled = false;
                startButton.innerHTML = "启动机器人";
                return;
            }
            if (!web3Instance) {
                web3Instance = await initializeWeb3();
                if (!web3Instance) {
                    startButton.disabled = false;
                    startButton.innerHTML = "启动机器人";
                    return;
                }
            }
            await checkTokenDecimals();
            const approved = await checkAndApproveToken(wallet);
            if (!approved) {
                startButton.disabled = false;
                startButton.innerHTML = "启动机器人";
                return;
            }
            botRunning = true;
            log(`加载钱包: ${wallet.address}`);
            log(`网格设置: ${grids.map(g => `${g.type === "buy" ? "买" : g.type === "sell" ? "卖" : "中立"}@${g.price} GT`).join(", ")}`);
            status.textContent += `加载钱包: ${wallet.address}\n`;
            autoBuyInterval = setInterval(async () => {
                if (!botRunning || !web3Instance) return;
                const routerContract = new web3Instance.eth.Contract(GATE_ROUTER_ABI, GATE_ROUTER_ADDRESS);
                const GTAmount = parseFloat(document.getElementById("gridAmount").value);
                const path = [WGT_ADDRESS, selectedToken];
                const amounts = await routerContract.methods.getAmountsOut(web3Instance.utils.toWei("1", "ether"), path).call();
                const currentPrice = web3Instance.utils.fromWei(amounts[1], tokenDecimals === 1 ? "ether" : "ether");
                log(`当前价格: ${currentPrice} GT`);
                for (const grid of grids) {
                    if (grid.type === "buy" && parseFloat(currentPrice) <= parseFloat(grid.price)) {
                        log(getMessage("buyingToken") + wallet.address + ` (${GTAmount} GT @ ${grid.price} GT)`);
                        await purchaseGateSwap(wallet, GTAmount);
                    } else if (grid.type === "sell" && parseFloat(currentPrice) >= parseFloat(grid.price)) {
                        const tokenAmount = (GTAmount / parseFloat(currentPrice)).toFixed(tokenDecimals === 1 ? 1 : 4);
                        log(getMessage("sellingToken") + wallet.address + ` (${tokenAmount} ${tokenSymbol} @ ${grid.price} GT)`);
                        await sellGateSwap(wallet, tokenAmount);
                    }
                }
                await checkBalances();
            }, 10000);
            log(`网格交易启动: 每 10 秒检查 ${tokenSymbol} 价格`);
            status.textContent += `网格交易 ${tokenSymbol} 启动\n`;
            startButton.disabled = false;
            startButton.innerHTML = "启动机器人";
        }

        function stopBot() {
            const stopButton = document.getElementById("stopButton");
            stopButton.disabled = true;
            stopButton.innerHTML = getMessage("buttonProcessing") + ' <i class="fa fa-spinner fa-spin ml-2"></i>';
            if (autoBuyInterval) {
                clearInterval(autoBuyInterval);
                autoBuyInterval = null;
            }
            botRunning = false;
            log("机器人已停止");
            document.getElementById("status").textContent = "状态: 机器人已停止\n";
            document.getElementById("gridStatus").textContent = "网格状态: 未设置";
            stopButton.disabled = false;
            stopButton.innerHTML = "停止机器人";
        }

        document.addEventListener("DOMContentLoaded", () => {
            log("页面加载完成，准备启动机器人");
            document.getElementById("tokenSelect").addEventListener("change", async () => {
                selectedToken = document.getElementById("tokenSelect").value;
                tokenSymbol = Object.keys(TOKEN_ADDRESSES).find(key => TOKEN_ADDRESSES[key].toLowerCase() === selectedToken.toLowerCase()) || "未知";
                if (web3Instance && wallet) {
                    await checkTokenDecimals();
                    await checkAndApproveToken(wallet);
                    await checkBalances();
                }
            });
            document.getElementById("startButton").addEventListener("click", startBot);
            document.getElementById("stopButton").addEventListener("click", stopBot);
            document.getElementById("checkBalanceButton").addEventListener("click", checkBalances);
            document.getElementById("approveButton").addEventListener("click", approveToken);
            const menuToggle = document.getElementById("menuToggle");
            const mobileMenu = document.getElementById("mobileMenu");
            menuToggle.addEventListener("click", () => {
                mobileMenu.classList.toggle("hidden");
                menuToggle.innerHTML = mobileMenu.classList.contains("hidden") ? '<i class="fa fa-bars"></i>' : '<i class="fa fa-times"></i>';
            });
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener("click", function(e) {
                    e.preventDefault();
                    mobileMenu.classList.add("hidden");
                    menuToggle.innerHTML = '<i class="fa fa-bars"></i>';
                    document.querySelector(this.getAttribute("href")).scrollIntoView({ behavior: "smooth" });
                });
            });
            const navbar = document.getElementById("navbar");
            window.addEventListener("scroll", () => {
                if (window.scrollY > 50) {
                    navbar.classList.add("bg-dark/95", "shadow-lg");
                } else {
                    navbar.classList.remove("bg-dark/95", "shadow-lg");
                }
            });
        });
    </script>
</body>
</html>
